library(TCGAbiolinks)
library(dplyr)
library(maftools)
library(readr)
setwd("C:/Users/wp1g19/Documents/Revisit bioinformatics/Mutation/Mutation WD")
#Download the TCGA mutation data and place into a maf
tcgamutquery <- GDCquery(project = "TCGA-ESCA", 
                                      legacy = FALSE,
                                      data.category = "Simple Nucleotide Variation",
                         data.type = "Masked Somatic Mutation", 
                                      barcode =  c("TCGA-L7-A6VZ", "TCGA-IG-A4QS", "TCGA-L5-A8NV", "TCGA-R6-A6XG", "TCGA-R6-A6DQ", "TCGA-L5-A8NE", "TCGA-L5-A8NT", "TCGA-L5-A4OQ", "TCGA-2H-A9GH", "TCGA-R6-A8W8", "TCGA-L5-A8NJ", "TCGA-V5-AASX", "TCGA-L5-A4OP", "TCGA-L5-A8NF", "TCGA-L5-A8NM", "TCGA-L5-A8NR", "TCGA-2H-A9GN", "TCGA-L5-A8NS", "TCGA-L5-A4OI", "TCGA-2H-A9GO", "TCGA-R6-A8W5", "TCGA-L5-A88V", "TCGA-L5-A8NI", "TCGA-L5-A4OW", "TCGA-L5-A4OJ", "TCGA-L5-A8NW", "TCGA-R6-A6L6", "TCGA-L5-A891", "TCGA-RE-A7BO", "TCGA-IC-A6RE", "TCGA-JY-A6F8", "TCGA-JY-A93E", "TCGA-VR-AA4D", "TCGA-R6-A6KZ", "TCGA-S8-A6BV", "TCGA-X8-AAAR", "TCGA-L5-A4OO", "TCGA-JY-A6FB", "TCGA-JY-A93C", "TCGA-2H-A9GK", "TCGA-2H-A9GF", "TCGA-2H-A9GI", "TCGA-2H-A9GL", "TCGA-2H-A9GM", "TCGA-2H-A9GR","TCGA-JY-A6FH", "TCGA-JY-A93D", "TCGA-JY-A938", "TCGA-L5-A4OE", "TCGA-L5-A4OF", "TCGA-L5-A4OG","TCGA-L5-A4OH", "TCGA-L5-A4ON", "TCGA-L5-A4OR", "TCGA-L5-A4OS", "TCGA-L5-A4OT", "TCGA-L5-A4OU", "TCGA-L5-A4OX", "TCGA-L5-A8NG", "TCGA-L5-A8NH", "TCGA-L5-A8NL", "TCGA-L5-A8NN", "TCGA-L5-A8NU", "TCGA-L5-A43C", "TCGA-L5-A43I", "TCGA-L5-A88Y", "TCGA-M9-A5M8", "TCGA-Q9-A6FW", "TCGA-R6-A6DN", "TCGA-R6-A6L4", "TCGA-R6-A6XQ", "TCGA-R6-A6Y2", "TCGA-R6-A8WC", "TCGA-R6-A8WG", "TCGA-V5-A7RB", "TCGA-V5-A7RE", "TCGA-V5-AASW", "TCGA-VR-A8EQ", "TCGA-ZR-A9CJ"))
downloading_directory <- file.path(getwd(), "GDCdata")
GDCdownload(tcgamutquery, directory = downloading_directory, method = "api")

tcgamaf <- GDCprepare(tcgamutquery)
tcgamaf$Tumor_Sample_Barcode <- strtrim(tcgamaf$Tumor_Sample_Barcode, 12)
tcgaCN <- read.csv("C:/Users/wp1g19/Documents/Revisit bioinformatics/Copy number/TCGA/TCGAcopynumberoncoplot.csv", header = TRUE)
tcgamaf <- read.maf(tcgamaf, cnTable =  tcgaCN)

#Set out the genelist for filtering
genes <- c(
           "NLRC5",
           "CSDE1",
           "CIITA",
           "CANX",
           "ERAP1",
           "CD1C",
           "HLA-DRB1",
           "ERAP2",
           "CD1A",
           "SPPL2A",
           "TAPBP",
           "CD1B",
           "HLA-DQA1",
           "PDIA3",
           "LGMN",
           "CTSS",
           "CD1D",
           "PSMB9",
           "MR1",
           "TAPBPL",
           "TAP2",
           "HLA-A",
           "HLA-DQA2",
           "HLA-B",
           "HLA-DPA1",
           "TAP1",
           "HLA-DQB2",
           "HLA-DMA",
           "HLA-DRB5",
           "CALR",
           "HLA-DPB1",
           "B2M",
           "CD74",
           "RFXANK",
           "RFX5",
           "HLA-DRA",
           "HLA-C",
           "HLA-G",
           "PSMB8",
           "HLA-DOA",
           "IRF1",
           "CTSL",
           "HLA-DMB",
           "HLA-E",
           "PSMB10",
           "RFXAP")
#"TP53", "ARID1A", "PMS2", ,"ERBB2", "CDKN2A"
#import the ICGC mutation data and place into a maf

library(data.table)

# Set the chunk size
chunk_size <- 3

# Loop over the TSV file in chunks and process each chunk

ICGCmaf <-icgcSimpleMutationToMAF(
  "C:/Users/wp1g19/Documents/Revisit bioinformatics/Mutation/simple_somatic_mutation.open.ESAD-UK.tsv.gz",
  basename = NA,
  MAFobj = FALSE,
  clinicalData = NULL,
  removeDuplicatedVariants = TRUE,
  addHugoSymbol = TRUE
)
conv <- read.csv(file = "C:/Users/wp1g19/Documents/Revisit bioinformatics/Copy number/ICGC/ICGCdonorconv.csv", header = TRUE)
cnicgc <- readr::read_tsv("C:/Users/wp1g19/Documents/Revisit bioinformatics/Copy number/ICGC/CopynumberICGCforMAF.tsv")

joined <- match(cnicgc$icgc_sample_id, conv$icgc_donor_id)

cnicgc$Matched <- conv[joined,]
cnicgc <- as.data.frame(cnicgc)
cnicgc$icgc_sample_id <- cnicgc$Matched$icgc_sample_id
cnicgcfinal <- cnicgc[,1:3]
colnames(cnicgcfinal) <- c("Gene", "Sample_name", "CN")
ICGCmaf2 <- read.maf(ICGCmaf, cnTable = cnicgcfinal)

#Combine the MAF objects into one
mafs <- list(tcgamaf,ICGCmaf2)
cncombined <- rbind(cnicgcfinal, tcgaCN)
combinedmafs <- merge_mafs(mafs, cnTable = cncombined)

oncoplot(combinedmafs, genes = genes)
mutcount <- mutCountMatrix(
  combinedmafs,
  includeSyn = FALSE,
  countOnly = NULL,
  removeNonMutated = FALSE
)

totalmut <- as.data.frame(colSums(mutcount))
totalmut$Sample.names <- as.data.frame(rownames(totalmut))
colnames(totalmut) <- c("Mutation count", "Sample.names")
totalmut <- totalmut[c("Sample.names", "Mutation count")]

tmbmutss <- as.data.frame(tmb(combinedmafs, captureSize = 50, logScale = FALSE))

tmbmuts2 <- tmbmutss[c("Tumor_Sample_Barcode", "total")]
vc_cols = RColorBrewer::brewer.pal(n = 12, name = 'Paired')
names(vc_cols) = c(
  'Frame_Shift_Del',
  'Missense_Mutation',
  'Nonsense_Mutation',
  'Multi_Hit',
  'Frame_Shift_Ins',
  'In_Frame_Ins',
  'Splice_Site',
  'Translation_Start_Site',
  'Del',
  'Amp',
  'Multi_Hit',
  'Complex_Event'
)

oncoplot(combinedmafs,gene_mar = 8, colors = vc_cols, fontSize = 0.6, genes = genes,topBarData = tmbmuts2, logColBar = FALSE, titleText = "Mutation/Copy number Oncoplot of APM genes in combined TCGA/ICGC n = 502", removeNonMutated = FALSE, legend_height = 3, legendFontSize = 1.3, annotationFontSize = 1.5, SampleNamefontSize = 1.5, writeMatrix = TRUE, anno_height = 1, sepwd_samples = 0.0001,drawBox = TRUE, sepwd_genes = 0.01)

# prepare data for APM mutation boxplot for TMB
# Non-APM mut samples
Non_APMmut <- c("TCGA-L5-A43C",
  "TCGA-R6-A6Y2",
  "TCGA-JY-A6FB",
  "TCGA-L5-A8NV",
  "TCGA-L5-A4OW",
  "TCGA-L5-A88V",
  "TCGA-2H-A9GF",
  "TCGA-V5-A7RE",
  "TCGA-L5-A8NJ",
  "TCGA-2H-A9GH",
  "SA607724",
  "TCGA-R6-A8WG",
  "TCGA-VR-AA4D",
  "TCGA-S8-A6BV",
  "TCGA-JY-A93D",
  "TCGA-L5-A8NG",
  "SA607680",
  "SA130955",
  "SA594603",
  "SA607842",
  "TCGA-V5-AASW",
  "TCGA-IG-A4QS",
  "SA599230",
  "SA596980",
  "TCGA-JY-A93C",
  "TCGA-ZR-A9CJ",
  "SA607866",
  "SA597068",
  "SA607726",
  "SA607730",
  "TCGA-JY-A93E",
  "TCGA-L5-A4OH",
  "SA599276",
  "SA607750",
  "SA594412",
  "SA595015",
  "SA607760",
  "TCGA-L7-A6VZ",
  "SA594350",
  "SA594574",
  "SA595127",
  "SA528829",
  "SA607690",
  "SA528815",
  "SA607664",
  "TCGA-L5-A43I",
  "SA597237",
  "SA597102",
  "SA599294",
  "SA599242",
  "SA130919",
  "SA528997",
  "SA528792",
  "SA528799",
  "SA528888",
  "SA528899",
  "SA547453",
  "SA594311",
  "SA594582",
  "SA594651",
  "SA595164",
  "SA597214",
  "SA599210",
  "SA599226",
  "SA599236",
  "SA607717",
  "SA607844",
  "SA607846",
  "TCGA-R6-A6L6",
  "TCGA-R6-A6DQ",
  "SA594535",
  "SA130946",
  "SA597108",
  "TCGA-R6-A6KZ",
  "SA528864",
  "SA596951",
  "SA594643",
  "SA528795",
  "TCGA-L5-A4OS",
  "SA528827",
  "SA547440",
  "SA594663",
  "SA595010",
  "SA596929",
  "SA599287",
  "TCGA-IC-A6RE",
  "TCGA-JY-A938",
  "TCGA-VR-A8EQ",
  "TCGA-R6-A8W8",
  "TCGA-L5-A4OR",
  "SA607790",
  "TCGA-JY-A6F8",
  "TCGA-R6-A6DN",
  "TCGA-L5-A4OE",
  "SA595001",
  "TCGA-RE-A7BO",
  "SA597363",
  "TCGA-L5-A4OJ",
  "SA130921",
  "SA130925",
  "SA130945",
  "SA130965",
  "SA528798",
  "SA528816",
  "SA528854",
  "SA528886",
  "TCGA-2H-A9GR",
  "TCGA-L5-A4OX",
  "SA607662",
  "TCGA-L5-A8NT",
  "TCGA-2H-A9GL",
  "SA528802",
  "SA597405",
  "SA599206",
  "TCGA-2H-A9GO",
  "SA528823",
  "SA528881",
  "SA596876",
  "SA130951",
  "SA607806",
  "SA528925",
  "SA607834",
  "SA130940",
  "SA599240",
  "SA528813",
  "TCGA-L5-A4ON",
  "SA607762",
  "TCGA-2H-A9GM",
  "SA528928",
  "SA599244",
  "TCGA-2H-A9GK",
  "TCGA-R6-A6L4",
  "SA594906",
  "SA594525",
  "TCGA-L5-A4OQ",
  "SA130952",
  "SA130954",
  "SA130960",
  "SA130961",
  "SA528790",
  "SA528833",
  "SA528858",
  "SA528883",
  "SA528912",
  "SA528938",
  "SA594303",
  "SA594372",
  "SA594439",
  "SA594893",
  "SA594947",
  "SA595048",
  "SA595137",
  "SA596941",
  "SA596942",
  "SA597145",
  "SA597327",
  "SA599214",
  "SA599232",
  "SA599245",
  "SA599274",
  "SA607672",
  "SA607692",
  "SA607704",
  "SA607728",
  "SA607776",
  "SA607780",
  "SA607816",
  "SA607820",
  "SA607850",
  "TCGA-L5-A4OF",
  "TCGA-L5-A8NI",
  "TCGA-R6-A6XQ",
  "TCGA-R6-A8W5",
  "TCGA-V5-A7RB",
  "TCGA-V5-AASX",
  "TCGA-X8-AAAR",
  "SA547436",
  "SA528916",
  "SA607739",
  "SA607830",
  "TCGA-2H-A9GI",
  "SA607700",
  "SA528782",
  "SA597442",
  "SA599279",
  "TCGA-M9-A5M8",
  "SA547448",
  "SA528898",
  "SA599197",
  "SA599212",
  "SA594824",
  "SA130917",
  "SA528811",
  "SA594557",
  "SA528831",
  "SA599281",
  "SA547451",
  "SA528901",
  "SA594988",
  "SA528806",
  "SA528909",
  "SA528939",
  "SA594790",
  "SA528855",
  "SA599293",
  "SA528861",
  "SA528926",
  "SA594806",
  "SA607670",
  "SA528932",
  "SA595024",
  "SA599266",
  "SA130927",
  "SA607786",
  "SA607711",
  "SA607860",
  "SA528825",
  "TCGA-Q9-A6FW",
  "SA130948",
  "SA528819",
  "SA528843",
  "SA528878",
  "SA528884",
  "SA528890",
  "SA547455",
  "SA594332",
  "SA594391",
  "SA594547",
  "SA594775",
  "SA594966",
  "SA595076",
  "SA595158",
  "SA596893",
  "SA597247",
  "SA597317",
  "SA597346",
  "SA599258",
  "SA599268",
  "SA599278",
  "SA607668",
  "SA607676",
  "SA607686",
  "SA607782",
  "SA607788",
  "SA607812",
  "SA607814",
  "SA607826",
  "SA607840",
  "SA607862",
  "SA607864",
  "TCGA-L5-A4OO",
  "SA597378",
  "SA528876",
  "SA597337",
  "SA599283",
  "SA528922",
  "SA597203",
  "SA596984",
  "SA607707",
  "SA597274",
  "SA594620",
  "SA597005",
  "SA599222",
  "SA607715",
  "SA599220",
  "SA528807",
  "SA607804",
  "SA528784",
  "SA528822",
  "SA528838",
  "SA594208",
  "SA594428",
  "SA595111",
  "SA595153",
  "SA597400",
  "SA597438",
  "SA599237",
  "SA607654",
  "SA607688",
  "SA607703",
  "SA607764",
  "SA607800",
  "SA607784",
  "TCGA-L5-A88Y",
  "SA597309",
  "SA607734",
  "SA594263",
  "SA130931",
  "SA528906",
  "SA594363",
  "SA594422",
  "SA594443",
  "SA597047",
  "SA607684",
  "SA594717",
  "SA599204",
  "SA594932",
  "SA607682",
  "SA607696",
  "SA597387",
  "SA607794",
  "SA528993",
  "SA547442",
  "SA599248",
  "SA528947",
  "SA599270",
  "SA597021",
  "SA607698",
  "SA595063",
  "SA528793",
  "SA594851",
  "SA597251",
  "SA528918",
  "SA594769",
  "SA528809",
  "SA607722",
  "SA528786",
  "SA594638",
  "SA607774",
  "SA594630",
  "SA599250",
  "SA607742",
  "SA597172",
  "SA607710",
  "SA607770",
  "SA607848",
  "SA528872",
  "SA599252",
  "SA528991",
  "SA528903",
  "SA594455",
  "SA607736",
  "SA599256",
  "SA599260",
  "SA594937",
  "SA130939",
  "SA130943",
  "SA130949",
  "SA528788",
  "SA528805",
  "SA528836",
  "SA528845",
  "SA528846",
  "SA528853",
  "SA528863",
  "SA528870",
  "SA528874",
  "SA528892",
  "SA528895",
  "SA528896",
  "SA528900",
  "SA528902",
  "SA528904",
  "SA528914",
  "SA528943",
  "SA528999",
  "SA547444",
  "SA547446",
  "SA547450",
  "SA594200",
  "SA594222",
  "SA594240",
  "SA594320",
  "SA594385",
  "SA594485",
  "SA594494",
  "SA594510",
  "SA594610",
  "SA594693",
  "SA594704",
  "SA594745",
  "SA594875",
  "SA594885",
  "SA594913",
  "SA594971",
  "SA594985",
  "SA595055",
  "SA595084",
  "SA595122",
  "SA595150",
  "SA596911",
  "SA596918",
  "SA597059",
  "SA597087",
  "SA597197",
  "SA597244",
  "SA597293",
  "SA597422",
  "SA597430",
  "SA599201",
  "SA599208",
  "SA599215",
  "SA599218",
  "SA599224",
  "SA599234",
  "SA599254",
  "SA599262",
  "SA599264",
  "SA599285",
  "SA599289",
  "SA599291",
  "SA607656",
  "SA607708",
  "SA607713",
  "SA607719",
  "SA607720",
  "SA607732",
  "SA607744",
  "SA607746",
  "SA607754",
  "SA607756",
  "SA607766",
  "SA607792",
  "SA607796",
  "SA607802",
  "SA607818",
  "SA607822",
  "SA607824",
  "SA607832",
  "SA607836",
  "SA607852",
  "SA607854",
  "SA607856",
  "SA607858",
  "TCGA-L5-A8NE",
  "TCGA-L5-A8NN",
  "TCGA-L5-A8NU")

tmbmutsnonAPM_mut <- tmbmuts2[ tmbmuts2$Tumor_Sample_Barcode %in% Non_APMmut ,]
APMmut <- c("TCGA-L5-A8NR",
            "TCGA-R6-A8WC",
            "TCGA-L5-A4OU",
            "SA597188",
            "TCGA-2H-A9GN",
            "SA599228",
            "TCGA-L5-A4OT",
            "TCGA-L5-A4OP",
            "TCGA-L5-A8NS",
            "SA607768",
            "SA528908",
            "TCGA-L5-A8NL",
            "TCGA-L5-A8NH",
            "SA596963",
            "SA528949",
            "TCGA-L5-A4OG",
            "SA607808",
            "SA607748",
            "SA607674",
            "SA597265",
            "TCGA-L5-A8NW",
            "SA599272",
            "SA597434",
            "SA528850",
            "SA594471",
            "SA594992",
            "TCGA-L5-A891",
            "TCGA-JY-A6FH",
            "SA607694",
            "SA528810",
            "SA528866",
            "TCGA-L5-A8NM",
            "SA607740",
            "SA607758",
            "SA528995",
            "SA528868",
            "SA594866",
            "SA595096",
            "TCGA-L5-A8NF",
            "SA595033",
            "SA607658",
            "SA130957",
            "SA130958",
            "SA607666",
            "SA528848",
            "SA607828",
            "TCGA-L5-A4OI",
            "SA130923",
            "SA528945",
            "SA547432",
            "SA607752",
            "SA596992",
            "SA595141",
            "SA597029",
            "SA594570",
            "SA528941",
            "SA130963",
            "SA528920",
            "SA597356",
            "SA597413",
            "SA528930",
            "SA595091",
            "SA528839",
            "SA597129",
            "TCGA-R6-A6XG",
            "SA130942",
            "SA607810",
            "SA599295",
            "SA607678",
            "SA607838",
            "SA594926",
            "SA607798",
            "SA607660",
            "SA607772",
            "SA607778")

tmbmutsAPM_mut <- tmbmuts2[tmbmuts2$Tumor_Sample_Barcode %in% APMmut ,]

write.csv(tmbmutsnonAPM_mut, file = "C:/Users/wp1g19/Documents/Revisit bioinformatics/Mutation/TMB_nonAPM_Mutation_samples.csv")
write.csv(tmbmutsAPM_mut, file = "C:/Users/wp1g19/Documents/Revisit bioinformatics/Mutation/TMB_APM_Mutation_samples.csv")


#551 mutation plot with APM mutation status
backup <- combinedmafs@clinical.data
APMmutstatus <- read.csv(file = "C:/Users/wp1g19/Documents/Revisit bioinformatics/Mutation/APM mutation status samples.csv", header = TRUE)
combinedmafs@clinical.data$Tumor_Sample_Barcode <- APMmutstatus$Tumor_Sample_Barcode
combinedmafs@clinical.data$APM.mutation.status <- APMmutstatus$APM.mutation.status
# List driver mutations from 551 Frankell paper

genes551 <- c("TP53",
              "CDKN2A",
              "KRAS",
              "MYC",
              "ERBB2",
              "GATA4",
              "CCND1",
              "GATA6",
              "SMAD4",
              "CDK6",
              "ARID1A",
              "EGFR",
              "CCNE1",
              "CCND3",
              "MUC6",
              "MDM2",
              "KCNQ3",
              "APC",
              "SMARCA4",
              "PIK3CA",
              "ABCB1",
              "PTEN",
              "MET",
              "RNF43",
              "DNAH7",
              "TSHZ3",
              "LRRK2",
              "TRPA1",
              "NAV3",
              "ARID2",
              "SLIT2",
              "EPHA3",
              "SCN3A",
              "CRISPLD1",
              "AXIN1",
              "FBXW7",
              "PPM1D",
              "ACVR2A",
              "RASA1",
              "CD1A",
              "CCDC102B",
              "CHL1",
              "LIN7A",
              "COIL",
              "MAP2K7",
              "EPHA2",
              "PBRM1",
              "POLQ",
              "ARID1B",
              "CTNNB1",
              "SIN3A",
              "RPL22",
              "PIK3R1",
              "MAP3K1",
              "NIPBL",
              "B2M",
              "FAM196B",
              "HIST1H3B",
              "TGFBR2",
              "MBD6",
              "BRAF",
              "MSH3",
              "CHD4",
              "CDH1",
              "GATAD1",
              "KDM6A",
              "CDKN1B",
              "ACVR1B",
              "STK11",
              "NOTCH1",
              "ZFHX3",
              "JAK1",
              "PCDH17",
              "ELF3",
              "GPATCH8",
              "C3orf62")

oncoplot(combinedmafs,gene_mar = 8,clinicalFeatures = "APM.mutation.status", colors = vc_cols, fontSize = 0.6, genes = genes551,topBarData = tmbmuts2, logColBar = TRUE, titleText = "Mutation Oncoplot of driver genes in combined TCGA/ICGC n = 502", removeNonMutated = FALSE, legend_height = 2, legendFontSize = 1.3, annotationFontSize = 1.5, SampleNamefontSize = 1.5, writeMatrix = TRUE)
